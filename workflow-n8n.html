<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTACRISES - Workflow Final avec Functions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        .toolbar {
            height: 65px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 25px;
            justify-content: space-between;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toolbar-title {
            font-size: 20px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .toolbar-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        .toolbar-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }

        .canvas-container {
            width: 100%;
            height: calc(100vh - 65px);
            position: relative;
            overflow: hidden;
            background: #fafafa;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 19px, #e5e5e5 19px, #e5e5e5 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #e5e5e5 19px, #e5e5e5 20px);
            background-size: 20px 20px;
        }

        #workflow-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #workflow-canvas:active {
            cursor: grabbing;
        }

        .node {
            cursor: pointer;
            transition: all 0.2s;
        }

        .node:hover {
            filter: brightness(1.08);
        }

        .node:hover .node-rect {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));
        }

        .node-rect {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.15));
            transition: all 0.2s;
        }

        .node-text {
            pointer-events: none;
            user-select: none;
        }

        .connection {
            fill: none;
            stroke: #999;
            stroke-width: 2.5;
            marker-end: url(#arrowhead);
            opacity: 0.7;
        }

        .connection-animated {
            stroke-dasharray: 8, 4;
            animation: dash 25s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .connection-critical {
            stroke: #dc2626;
            stroke-width: 4;
            marker-end: url(#arrowhead-critical);
            opacity: 1;
            animation: pulse-connection 2s infinite;
        }

        @keyframes pulse-connection {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .connection-loop {
            stroke: #8b5cf6;
            stroke-width: 3.5;
            stroke-dasharray: 12, 6;
            marker-end: url(#arrowhead-loop);
            opacity: 0.9;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: 600;
            color: #333;
        }

        .zoom-btn:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .zoom-btn:not(:last-child) {
            border-bottom: 1px solid #e5e5e5;
        }

        .legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            font-size: 12px;
            max-width: 250px;
            border: 1px solid #e5e5e5;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: #333;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .stats-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 18px 22px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            font-size: 13px;
            border: 1px solid #e5e5e5;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 25px;
            margin: 6px 0;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            font-weight: 700;
            color: #667eea;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            font-size: 13px;
            max-width: 380px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            border: 1px solid #e5e5e5;
        }

        .info-panel h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .info-panel p {
            color: #666;
            line-height: 1.7;
            margin: 8px 0;
        }

        .info-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 700;
            margin: 4px 4px 4px 0;
        }

        .badge-large {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .badge-small {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-web {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .info-functions {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .info-functions-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .info-function {
            font-size: 11px;
            color: #475569;
            margin: 4px 0;
            padding-left: 12px;
        }

        .info-function::before {
            content: "âš¡";
            margin-right: 6px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 28px;
            height: 28px;
            border: none;
            background: #f1f5f9;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #e2e8f0;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-left">
            <div>
                <div class="toolbar-title">ðŸš¨ GESTACRISES - Workflow avec Functions</div>
                <div class="toolbar-subtitle">14 Agents Mistral â€¢ Tools & Web Search â€¢ Boucle Continue</div>
            </div>
        </div>
        <div class="toolbar-controls">
            <button class="btn" onclick="resetView()">
                <span>ðŸ”„</span> RÃ©initialiser
            </button>
            <button class="btn" onclick="fitToScreen()">
                <span>â›¶</span> Vue d'ensemble
            </button>
            <button class="btn" onclick="exportWorkflow()">
                <span>ðŸ’¾</span> Exporter JSON
            </button>
        </div>
    </div>

    <div class="canvas-container">
        <svg id="workflow-canvas" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#999" />
                </marker>
                <marker id="arrowhead-critical" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto">
                    <polygon points="0 0, 12 3, 0 6" fill="#dc2626" />
                </marker>
                <marker id="arrowhead-loop" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto">
                    <polygon points="0 0, 12 3, 0 6" fill="#8b5cf6" />
                </marker>
            </defs>
            <g id="connections"></g>
            <g id="nodes"></g>
        </svg>

        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
            <button class="zoom-btn" onclick="resetZoom()">âŠ™</button>
        </div>

        <div class="legend">
            <div class="legend-title">ðŸ“Œ LÃ©gende</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fca5a5;"></div>
                <span><strong>LARGE</strong> (10 agents)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #86efac;"></div>
                <span><strong>SMALL</strong> (3 agents)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #93c5fd;"></div>
                <span><strong>SMALL + Web</strong> (1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fcd34d;"></div>
                <span><strong>Validations</strong> (6)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c4b5fd;"></div>
                <span><strong>Boucle</strong></span>
            </div>
        </div>

        <div class="stats-overlay">
            <div class="stat-row">
                <span class="stat-label">Total Agents :</span>
                <span class="stat-value">14</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">LARGE :</span>
                <span class="stat-value">10</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SMALL :</span>
                <span class="stat-value">3</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">WEB Search :</span>
                <span class="stat-value">1</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Validations :</span>
                <span class="stat-value">6</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Functions :</span>
                <span class="stat-value">7</span>
            </div>
            <div class="stat-row">
                <span class="stat-value"></span>
            </div>
        </div>

        <div class="info-panel" id="info-panel">
            <button class="close-btn" onclick="closeInfo()">âœ•</button>
            <h3 id="info-title"></h3>
            <p id="info-description"></p>
            <div id="info-badges"></div>
            <div id="info-functions"></div>
        </div>
    </div>

    <script>
        // DÃ©finition des agents avec leurs fonctions
        const agentsFunctions = {
            'agent1': ['lire_pcs', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent2': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent3': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent4': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent5': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent6': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent7': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent8': ['lire_contexte', 'generer_document', 'ecrire_main_courante'],
            'agent9': ['lire_contexte', 'generer_document', 'envoyer_notification', 'ecrire_main_courante'],
            'agent10': ['lire_contexte', 'sauvegarder_etat', 'ecrire_main_courante'],
            'agent11': ['web_search', 'ecrire_main_courante', 'envoyer_notification'],
            'agent12': ['lire_contexte', 'ecrire_main_courante'],
            'agent13': ['lire_contexte', 'rechercher_evenements', 'web_search', 'envoyer_notification', 'ecrire_main_courante'],
            'agent14': ['lire_contexte', 'generer_document']
        };

        const agentsDescriptions = {
            'agent1': 'Extraction automatique du PCS - Acteurs, moyens, risques, procÃ©dures',
            'agent2': 'Analyse MEDO : Mission, Environnement, Situation, Besoins & Moyens',
            'agent3': 'Analyse de la mission du PCC - Composantes, tÃ¢ches, libertÃ© d\'action',
            'agent4': 'Confrontation Besoins vs Moyens - Forces, faiblesses, renforts',
            'agent5': 'DÃ©termine l\'effet majeur qui conditionne le succÃ¨s',
            'agent6': 'GÃ©nÃ¨re et compare 2-3 modes d\'action possibles',
            'agent7': 'Reformule le mode d\'action dÃ©finitif aprÃ¨s validation',
            'agent8': 'GÃ©nÃ¨re les ordres et consignes pour les cellules du PCC',
            'agent9': 'CrÃ©e le plan de communication multi-publics',
            'agent10': 'Configure le systÃ¨me de pilotage continu',
            'agent11': 'Surveille le web selon le type de crise (mÃ©tÃ©o, crues, etc.)',
            'agent12': 'Classifie les Ã©vÃ©nements : Critique ou Pas critique',
            'agent13': 'RÃ©Ã©value la situation si Ã©vÃ©nement critique dÃ©tectÃ©',
            'agent14': 'GÃ©nÃ¨re les documents Ã  la demande (PDF, DOCX, etc.)'
        };

        // Configuration du workflow
        const nodes = [
            { id: 'start', x: 500, y: 50, label: 'DÃ‰MARRAGE', icon: 'ðŸš¨', type: 'start' },
            
            // PHASE 1
            { id: 'phase1', x: 500, y: 150, label: 'COMPRENDRE', icon: 'ðŸ“Š', type: 'phase', width: 160 },
            { id: 'agent1', x: 500, y: 250, label: 'Agent 1\nExtracteur', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'agent2', x: 500, y: 340, label: 'Agent 2\nMEDO', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val1', x: 500, y: 430, label: 'Val 1', icon: 'âœ‹', type: 'validation', width: 80 },
            { id: 'agent3', x: 500, y: 510, label: 'Agent 3\nMission', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val2', x: 500, y: 600, label: 'Val 2', icon: 'âœ‹', type: 'validation', width: 80 },
            { id: 'agent4', x: 500, y: 680, label: 'Agent 4\nBesoins', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val3', x: 500, y: 770, label: 'Val 3', icon: 'âœ‹', type: 'validation', width: 80 },
            { id: 'agent5', x: 500, y: 850, label: 'Agent 5\nEffet Maj.', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val4', x: 500, y: 940, label: 'Val 4', icon: 'âœ‹', type: 'validation', width: 80 },
            
            // PHASE 2
            { id: 'phase2', x: 500, y: 1030, label: 'DÃ‰CIDER', icon: 'ðŸŽ¯', type: 'phase', width: 160 },
            { id: 'agent6', x: 500, y: 1130, label: 'Agent 6\nModes', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val5', x: 500, y: 1220, label: 'Val 5\nCRITIQUE', icon: 'âš ï¸', type: 'critical', width: 100 },
            { id: 'agent7', x: 500, y: 1310, label: 'Agent 7\nReform.', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val6', x: 500, y: 1400, label: 'Val 6', icon: 'âœ‹', type: 'validation', width: 80 },
            
            // PHASE 3
            { id: 'phase3', x: 500, y: 1490, label: 'DIRIGER', icon: 'ðŸš€', type: 'phase', width: 160 },
            { id: 'agent8', x: 350, y: 1590, label: 'Agent 8\nOrdres', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'agent9', x: 500, y: 1590, label: 'Agent 9\nComm', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'agent10', x: 650, y: 1590, label: 'Agent 10\nPilotage', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            
            // BOUCLE
            { id: 'loop', x: 500, y: 1710, label: 'BOUCLE', icon: 'ðŸ”„', type: 'loop', width: 140 },
            { id: 'input-human', x: 300, y: 1820, label: 'Ã‰vÃ©nements\nHumains', icon: 'ðŸ‘¤', type: 'input', width: 110 },
            { id: 'agent11', x: 700, y: 1820, label: 'Agent 11\nVeilleur', icon: 'ðŸŒ', type: 'web', model: 'SMALL+WEB' },
            { id: 'agent12', x: 500, y: 1940, label: 'Agent 12\nTrieur', icon: 'ðŸ¤–', type: 'small', model: 'SMALL' },
            { id: 'decision', x: 500, y: 2030, label: 'Critique?', icon: 'ðŸ”€', type: 'decision', width: 90 },
            { id: 'main-courante', x: 300, y: 2120, label: 'Main-\ncourante', icon: 'ðŸ“', type: 'output-small', width: 100 },
            { id: 'agent13', x: 700, y: 2120, label: 'Agent 13\nRÃ©Ã©val.', icon: 'ðŸ¤–', type: 'large', model: 'LARGE' },
            { id: 'val-event', x: 700, y: 2210, label: 'Val Evt', icon: 'âœ‹', type: 'validation', width: 80 },
            
            // RESTITUTION
            { id: 'agent14', x: 900, y: 1820, label: 'Agent 14\nDocs', icon: 'ðŸ“„', type: 'small', model: 'SMALL' },
        ];

        const connections = [
            // Flux principal
            { from: 'start', to: 'phase1', type: 'animated' },
            { from: 'phase1', to: 'agent1' },
            { from: 'agent1', to: 'agent2' },
            { from: 'agent2', to: 'val1' },
            { from: 'val1', to: 'agent3' },
            { from: 'agent3', to: 'val2' },
            { from: 'val2', to: 'agent4' },
            { from: 'agent4', to: 'val3' },
            { from: 'val3', to: 'agent5' },
            { from: 'agent5', to: 'val4' },
            { from: 'val4', to: 'phase2', type: 'animated' },
            { from: 'phase2', to: 'agent6' },
            { from: 'agent6', to: 'val5' },
            { from: 'val5', to: 'agent7', type: 'critical' },
            { from: 'agent7', to: 'val6' },
            { from: 'val6', to: 'phase3', type: 'animated' },
            { from: 'phase3', to: 'agent8' },
            { from: 'phase3', to: 'agent9' },
            { from: 'phase3', to: 'agent10' },
            { from: 'agent8', to: 'loop' },
            { from: 'agent9', to: 'loop' },
            { from: 'agent10', to: 'loop' },
            
            // Boucle
            { from: 'loop', to: 'input-human' },
            { from: 'loop', to: 'agent11' },
            { from: 'input-human', to: 'agent12' },
            { from: 'agent11', to: 'agent12' },
            { from: 'agent12', to: 'decision' },
            { from: 'decision', to: 'main-courante' },
            { from: 'decision', to: 'agent13' },
            { from: 'agent13', to: 'val-event' },
            
            // Retour boucle
            { from: 'val-event', to: 'loop', type: 'loop' },
            { from: 'main-courante', to: 'loop', type: 'loop' },
            
            // Restitution
            { from: 'loop', to: 'agent14' },
        ];

        // Variables de contrÃ´le
        let scale = 0.5;
        let translateX = 0;
        let translateY = 0;
        let isPanning = false;
        let startX, startY;

        const svg = document.getElementById('workflow-canvas');
        const nodesGroup = document.getElementById('nodes');
        const connectionsGroup = document.getElementById('connections');

        // Couleurs
        const colors = {
            start: { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
            phase: { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
            large: { bg: '#fecaca', border: '#dc2626', text: '#991b1b' },
            small: { bg: '#bbf7d0', border: '#22c55e', text: '#166534' },
            web: { bg: '#bfdbfe', border: '#3b82f6', text: '#1e40af' },
            validation: { bg: '#fef3c7', border: '#fbbf24', text: '#92400e' },
            critical: { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
            loop: { bg: '#e9d5ff', border: '#8b5cf6', text: '#6d28d9' },
            decision: { bg: '#fed7aa', border: '#fb923c', text: '#9a3412' },
            input: { bg: '#e0e7ff', border: '#818cf8', text: '#3730a3' },
            'output-small': { bg: '#d1fae5', border: '#10b981', text: '#065f46' }
        };

        function drawConnections() {
            connectionsGroup.innerHTML = '';
            
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (!fromNode || !toNode) return;
                
                const fromX = fromNode.x;
                const fromY = fromNode.y + (fromNode.height || 50);
                const toX = toNode.x;
                const toY = toNode.y;
                
                if (conn.type === 'loop') {
                    const path = `M ${fromX} ${fromY} 
                                 C ${fromX + 250} ${fromY}, ${toX + 250} ${toY}, ${toX} ${toY}`;
                    
                    const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.setAttribute('d', path);
                    pathElement.classList.add('connection', 'connection-loop');
                    connectionsGroup.appendChild(pathElement);
                } else {
                    const midY = (fromY + toY) / 2;
                    const path = `M ${fromX} ${fromY} 
                                 C ${fromX} ${midY}, ${toX} ${midY}, ${toX} ${toY}`;
                    
                    const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.setAttribute('d', path);
                    pathElement.classList.add('connection');
                    
                    if (conn.type === 'animated') pathElement.classList.add('connection-animated');
                    if (conn.type === 'critical') pathElement.classList.add('connection-critical');
                    
                    connectionsGroup.appendChild(pathElement);
                }
            });
        }

        function drawNodes() {
            nodesGroup.innerHTML = '';
            
            nodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('node');
                g.setAttribute('data-id', node.id);
                
                const width = node.width || 120;
                const height = node.height || 50;
                const x = node.x - width / 2;
                const y = node.y;
                
                const color = colors[node.type] || colors.large;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', width);
                rect.setAttribute('height', height);
                rect.setAttribute('rx', 8);
                rect.setAttribute('fill', color.bg);
                rect.setAttribute('stroke', color.border);
                rect.setAttribute('stroke-width', 2);
                rect.classList.add('node-rect');
                
                const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                icon.setAttribute('x', node.x - width / 2 + 10);
                icon.setAttribute('y', y + height / 2 + 5);
                icon.setAttribute('font-size', '16');
                icon.textContent = node.icon;
                icon.classList.add('node-text');
                
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', node.x);
                label.setAttribute('y', y + height / 2 + 4);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '11');
                label.setAttribute('font-weight', '600');
                label.setAttribute('fill', color.text);
                label.classList.add('node-text');
                
                const lines = node.label.split('\n');
                if (lines.length > 1) {
                    label.setAttribute('y', y + height / 2 - 4);
                    lines.forEach((line, i) => {
                        const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                        tspan.setAttribute('x', node.x);
                        tspan.setAttribute('dy', i === 0 ? 0 : 12);
                        tspan.textContent = line;
                        label.appendChild(tspan);
                    });
                } else {
                    label.textContent = node.label;
                }
                
                g.appendChild(rect);
                g.appendChild(icon);
                g.appendChild(label);
                
                g.addEventListener('click', () => showNodeInfo(node));
                g.addEventListener('mouseenter', () => rect.setAttribute('stroke-width', 3));
                g.addEventListener('mouseleave', () => rect.setAttribute('stroke-width', 2));
                
                nodesGroup.appendChild(g);
            });
        }

        function showNodeInfo(node) {
            const panel = document.getElementById('info-panel');
            const title = document.getElementById('info-title');
            const description = document.getElementById('info-description');
            const badges = document.getElementById('info-badges');
            const functionsDiv = document.getElementById('info-functions');
            
            title.textContent = `${node.icon} ${node.label.replace('\n', ' ')}`;
            description.textContent = agentsDescriptions[node.id] || `Node: ${node.id}`;
            
            badges.innerHTML = '';
            if (node.model) {
                const badge = document.createElement('span');
                badge.className = 'info-badge ' + (node.model.includes('LARGE') ? 'badge-large' : node.model.includes('WEB') ? 'badge-web' : 'badge-small');
                badge.textContent = node.model;
                badges.appendChild(badge);
            }
            
            functionsDiv.innerHTML = '';
            if (agentsFunctions[node.id]) {
                functionsDiv.innerHTML = '<div class="info-functions-title">âš¡ Functions disponibles :</div>';
                agentsFunctions[node.id].forEach(func => {
                    const funcDiv = document.createElement('div');
                    funcDiv.className = 'info-function';
                    funcDiv.textContent = func;
                    functionsDiv.appendChild(funcDiv);
                });
                functionsDiv.className = 'info-functions';
            }
            
            panel.style.display = 'block';
        }

        function closeInfo() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function updateTransform() {
            nodesGroup.setAttribute('transform', `translate(${translateX}, ${translateY}) scale(${scale})`);
            connectionsGroup.setAttribute('transform', `translate(${translateX}, ${translateY}) scale(${scale})`);
        }

        svg.addEventListener('mousedown', (e) => {
            if (e.target === svg || e.target.tagName === 'rect') {
                isPanning = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
            }
        });

        svg.addEventListener('mousemove', (e) => {
            if (isPanning) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });

        svg.addEventListener('mouseup', () => isPanning = false);
        svg.addEventListener('mouseleave', () => isPanning = false);

        svg.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            scale = Math.max(0.1, Math.min(3, scale));
            updateTransform();
        });

        function zoomIn() {
            scale *= 1.2;
            scale = Math.min(3, scale);
            updateTransform();
        }

        function zoomOut() {
            scale *= 0.8;
            scale = Math.max(0.1, scale);
            updateTransform();
        }

        function resetZoom() {
            scale = 0.5;
            updateTransform();
        }

        function resetView() {
            scale = 0.5;
            translateX = 0;
            translateY = 0;
            updateTransform();
        }

        function fitToScreen() {
            scale = 0.4;
            translateX = 50;
            translateY = 50;
            updateTransform();
        }

        function exportWorkflow() {
            const workflow = {
                name: 'GESTACRISES Workflow Final',
                version: '2.0',
                agents: 14,
                functions: 7,
                nodes: nodes,
                connections: connections,
                agentsFunctions: agentsFunctions,
            };
            
            const dataStr = JSON.stringify(workflow, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'gestacrises-workflow-final.json';
            link.click();
        }

        // Initialisation
        drawConnections();
        drawNodes();
        fitToScreen();
    </script>
</body>
</html>
